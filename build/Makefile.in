# Copyright (C) 2006-2009, The Perl Foundation.

PARROT_ARGS      =

# values from parrot_config
PARROT_BIN_DIR     = @bindir@
PARROT_VERSION     = @versiondir@
PARROT_INCLUDE_DIR = @includedir@$(PARROT_VERSION)
PARROT_LIB_DIR     = @libdir@$(PARROT_VERSION)
PARROT_SRC_DIR     = @srcdir@$(PARROT_VERSION)
PARROT_LIBRARY_DIR = $(PARROT_LIB_DIR)/library
HAS_ICU            = @has_icu@

CC            = @cc@
CFLAGS        = @ccflags@ @cc_shared@ @cc_debug@ @ccwarn@ @cg_flag@ @gc_flag@
EXE           = @exe@
LD            = @ld@
LDFLAGS       = @ldflags@ @ld_debug@
LD_LOAD_FLAGS = @ld_load_flags@
LIBPARROT     = @inst_libparrot_ldflags@
O             = @o@
LOAD_EXT      = @load_ext@
PERL          = @perl@
CP            = @cp@
MV            = @mv@
RM_F          = @rm_f@
MKPATH        = $(PERL) -MExtUtils::Command -e mkpath
CHMOD         = $(PERL) -MExtUtils::Command -e chmod

# locations of parrot resources
PARROT           = $(PARROT_BIN_DIR)/parrot$(EXE)
PARROT_NQP       = $(PARROT_BIN_DIR)/parrot-nqp$(EXE)
PBC_TO_EXE       = $(PARROT_BIN_DIR)/pbc_to_exe$(EXE)
PARROT_TOOLS_DIR = $(PARROT_LIB_DIR)/tools
PARROT_PERL_LIB  = $(PARROT_TOOLS_DIR)/lib

PARROTLOG_LANG_DIR     = $(PARROT_LIB_DIR)/languages/parrotlog

PARROTLOG_EXE     = parrotlog$(EXE)
PARROTLOG_PBC     = parrotlog.pbc
PARROTLOG_G_PIR   = src/gen/parrotlog-grammar.pir
PARROTLOG_A_PIR   = src/gen/parrotlog-actions.pir
PARROTLOG_C_PIR   = src/gen/parrotlog-compiler.pir
PARROTLOG_R_PIR   = src/gen/parrotlog-runtime.pir
PARROTLOG_CT_PIR  = src/gen/parrotlog-coretest.pir

PARROTLOG_SOURCES = \
    src/parrotlog.pir \
	src/arithmetic.pir \
	src/types.pir \
    $(PARROTLOG_G_PIR) \
    $(PARROTLOG_A_PIR) \
    $(PARROTLOG_C_PIR) \
    $(PARROTLOG_R_PIR) \
	$(PARROTLOG_CT_PIR) \

CLEANUPS = \
  *.manifest \
  *.pdb \
  *.c\
  *.o\
  $(PARROTLOG_EXE) \
  $(PARROTLOG_PBC) \
  src/gen/*.pir \

default: $(PARROTLOG_EXE)

all: $(PARROTLOG_EXE)

$(PARROTLOG_EXE) : $(PARROTLOG_SOURCES)
	$(PARROT) -o $(PARROTLOG_PBC) src/parrotlog.pir
	$(PBC_TO_EXE) $(PARROTLOG_PBC)

$(PARROTLOG_G_PIR): src/parrotlog/Grammar.pm
	$(PARROT_NQP) --target=pir -o $(PARROTLOG_G_PIR) src/parrotlog/Grammar.pm
$(PARROTLOG_A_PIR): src/parrotlog/Actions.pm
	$(PARROT_NQP) --target=pir -o $(PARROTLOG_A_PIR) src/parrotlog/Actions.pm
$(PARROTLOG_C_PIR): src/parrotlog/Compiler.pm
	$(PARROT_NQP) --target=pir -o $(PARROTLOG_C_PIR) src/parrotlog/Compiler.pm
$(PARROTLOG_R_PIR): src/parrotlog/Runtime.pm
	$(PARROT_NQP) --target=pir -o $(PARROTLOG_R_PIR) src/parrotlog/Runtime.pm
$(PARROTLOG_CT_PIR): src/parrotlog/Coretest.pm
	$(PARROT_NQP) --target=pir -o $(PARROTLOG_CT_PIR) src/parrotlog/Coretest.pm

## testing

test: $(PARROTLOG_EXE)
	$(PERL) t/harness t

switest:
	prove -r -e 'swipl -q -t main -f' t/

## installation

install: all
	$(MKPATH)        $(DESTDIR)$(PARROTLOG_LANG_DIR)
	$(CP) $(PARROTLOG_PBC) $(DESTDIR)$(PARROTLOG_LANG_DIR)
	$(CP) $(PARROTLOG_EXE) $(DESTDIR)$(PARROT_BIN_DIR)
	$(CHMOD) 755     $(DESTDIR)$(PARROT_BIN_DIR)/$(PARROTLOG_EXE)

## cleaning

clean:
	$(RM_F) $(CLEANUPS)

distclean: realclean

realclean: clean
	$(RM_F) Makefile

testclean:

##  miscellaneous targets
# a listing of all targets meant to be called by users
help:
	@echo ""
	@echo "Following targets are available for the user:"
	@echo ""
	@echo "  all:               $(PARROTLOG_EXE)"
	@echo "                     This is the default."
	@echo "  $(PARROTLOG_EXE):        The parrotlog compiler."
	@echo "  install:           Install compiler into Parrot."
	@echo ""
	@echo "Testing:"
	@echo "  test:              Run tests."
	@echo ""
	@echo "Cleaning:"
	@echo "  clean:             Basic cleaning up."
	@echo "  distclean:         Removes also anything built, in theory."
	@echo "  realclean:         Removes also files generated by 'Configure.pl'."
	@echo "  testclean:         Clean up test results."
	@echo ""
	@echo "Misc:"
	@echo "  help:              Print this help message."
	@echo ""

